# 递归分析

本文档解释如何验证策略中因某些指标的递归问题而导致的不准确性。

递归公式是指序列中的任一项由其前一项（或多项）定义。例如，递归公式可以表示为a<sub>n</sub> = a<sub>n-1</sub> + b。

为什么这对Freqtrade很重要？在回测中，机器人会根据指定的时间范围获取交易对的完整数据。但在模拟/实盘运行中，机器人的数据量会受限于交易所提供的数据量。

例如，计算一个非常基础的指标`steps`：第一行的值始终为0，后续行的值等于前一行的值加1。如果使用最近1000根K线计算，那么第一行的`steps`值为0，最后一根已收盘K线的`steps`值为999。

如果仅使用最近500根K线计算会怎样？此时最后一根已收盘K线的`steps`值将是499，而非999。这种数值差异会导致回测结果与模拟/实盘结果不一致。

`recursive-analysis`命令需要可用的历史数据。要了解如何获取感兴趣的交易对和交易所的数据，请参阅文档的[数据下载](data-download.md)部分。

该命令通过准备不同长度的数据并基于这些数据计算指标来工作。它不会回测策略本身，而仅计算指标。在计算不同启动K线数量（`startup_candle_count`）的指标后，会比较所有指定`startup_candle_count`下最后一行的值，以查看它们与基准计算相比的偏差程度。

命令设置：

- 使用`-p`选项设置你想要分析的交易对。由于我们仅查看指标值，使用多个交易对是多余的。建议使用价格相对较高且波动性适中的交易对（如BTC或ETH），以避免舍入问题导致结果不准确。如果命令未设置交易对，将使用白名单中的第一个交易对进行分析。
- 建议设置较长的时间范围（至少5000根K线），以便用作基准的初始指标计算本身具有极小或无递归问题。例如，对于5分钟时间框架，5000根K线相当于18天。
- `--cache`被强制设为"none"，以避免自动加载之前的指标计算结果。

除了递归公式检查外，此命令还会对指标值进行简单的前瞻偏差检查。如需完整的前瞻检查，请使用[前瞻分析](lookahead-analysis.md)。

## 递归分析命令参考

--8<-- "commands/recursive-analysis.md"

### 为什么默认启动K线数量是奇数？

启动K线的默认值是奇数。当机器人从交易所API获取K线数据时，最后一根K线是机器人要检查的K线，其余数据为"启动K线"。

例如，Binance允许每次API调用返回1000根K线。当机器人收到1000根K线时，最后一根是"当前K线"，前999根是"启动K线"。如果将启动K线数量设置为1000而非999，机器人将尝试获取1001根K线。此时交易所API会分页返回数据（对于Binance API，会分为两组：一组1000根，一组1根）。这导致机器人认为策略需要1001根K线数据，因此会下载2000根K线，即1根"当前K线"和1999根"启动K线"。

此外，交易所会限制连续批量API调用的次数（如Binance允许5次调用）。在这种情况下，从Binance API最多可下载5000根K线而不触发API速率限制，这意味着`startup_candle_count`的最大值为4999。

请注意，交易所可能会在未事先通知的情况下更改此K线限制。

### 命令工作原理

- 首先，使用提供的时间范围进行初始指标计算，生成指标值的基准。
- 设置基准后，会对每个不同的启动K线数量执行额外计算。
- 然后，命令会比较最后一行K线的指标值，并在表格中报告差异。

## 理解递归分析输出

以下是至少一个指标存在递归公式问题的输出结果表示例：