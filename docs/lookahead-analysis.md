# 前瞻偏差分析

本页解释如何从前瞻偏差角度验证您的策略。

前瞻偏差是任何策略的祸根，因为引入这种偏差有时非常容易，但却很难检测。

回测会初始化所有时间戳（将整个数据帧加载到内存中）并一次性计算所有指标。
这意味着如果您的指标或入场/出场信号查看了未来的K线，将会使回测结果失真。

`lookahead-analysis` 命令需要可用的历史数据。
要了解如何获取您感兴趣的交易对和交易所的数据，请参阅文档的[数据下载](data-download.md)部分。
`lookahead-analysis` 也支持FreqAI策略。

该命令在内部链接多个回测，并通过探测策略来触发其显示前瞻偏差。
此过程不直接分析策略代码，而是通过比较指标值的变化以及与完整回测相比入场/出场点的移动来实现。

`lookahead-analysis` 可以使用[回测](backtesting.md)的典型选项，但会强制设置以下选项：

- `--cache` 强制设为 "none"。
- `--max-open-trades` 强制设为至少等于交易对数量。
- `--dry-run-wallet` 强制设为基本无限（10亿）。
- `--stake-amount` 强制设为固定的 10000（1万）。
- `--enable-protections` 强制关闭。

这些设置是为了避免用户意外产生误报。

## 前瞻偏差分析命令参考

--8<-- "commands/lookahead-analysis.md"

!!! 注意
    上述输出已精简为 `lookahead-analysis` 在常规回测命令基础上新增的选项。

### 简介

许多策略在开发者不知情的情况下受到了前瞻偏差的影响。
这通常会使策略回测看起来有利可图，有时甚至到了极端程度，但这并不现实，因为策略通过查看实盘或模拟交易中无法获得的数据来"作弊"。

策略之所以能"作弊"，是因为Freqtrade的回测过程在开始时就填充了包含所有K线时间戳的完整数据帧。
如果开发者不够谨慎，或者不了解内部工作原理（有时确实很难弄清楚），策略就会查看未来数据。

此命令旨在尝试通过上述前瞻偏差来验证策略的有效性。

### 命令工作原理

首先对所有交易对进行回测，生成指标和入场/出场点的基准数据。
初始回测运行后，会检查是否满足 `minimum-trade-amount`，如果不满足，则取消该策略的前瞻偏差分析。
如果发生这种情况，请使用更广的时间范围以获取更多用于分析的交易，或使用交易更多的时间范围。

设置基准后，会对每个入场和出场信号分别进行额外的回测。
验证回测完成后，会比较信号K线（入场或出场）处的指标，并报告偏差。
所有信号验证或证伪后，会生成结果表供用户查看。

### 如何发现和消除偏差？如何挽救有偏差的策略？

如果您在网上找到一个有偏差的策略，并希望获得相同的结果（但无偏差），大多数情况下可能会失望。
通常，策略中的偏差是"好得难以置信"的利润的驱动因素。
移除因偏差而推高利润的条件或指标，通常会使策略表现显著变差。
如果有偏差的指标或条件不是策略的核心，或者存在其他无偏差的入场和出场信号，则可能部分挽救策略。

### 前瞻偏差示例

- `shift(-10)` 会查看未来10根K线。
- 在 populate_* 函数中使用 `iloc[]` 访问数据帧中的特定行。
- 如果不严格控制循环范围，for循环容易引入前瞻偏差。
- 聚合函数如 `.mean()`、`.min()` 和 `.max()`，如果没有滚动窗口，会计算**整个**数据帧的值，因此信号K线会"看到"包含未来K线的值。
  无偏差的示例是使用 `rolling()` 回顾K线：例如 `dataframe['volume_mean_12'] = dataframe['volume'].rolling(12).mean()`
- `ta.MACD(dataframe, 12, 26, 1)` 当信号周期为1时会引入偏差。

### 结果表各列含义

- `filename`：被检查的策略文件名
- `strategy`：被检查的策略类名
- `has_bias`：前瞻偏差分析结果。`No` 表示良好，`Yes` 表示存在偏差。
- `total_signals`：检查的信号数量（默认20）
- `biased_entry_signals`：发现有偏差的入场信号数量
- `biased_exit_signals`：发现有偏差的出场信号数量
- `biased_indicators`：显示在 populate_indicators 中定义的有偏差指标

如果有偏差的入场信号与出场信号相关联，`biased_exit_signals` 可能会出现误报。
然而，有偏差的入场通常也会导致出场偏差，即使出场本身没有产生偏差——尤其是当入场和出场条件使用相同的有偏差指标时。

**首先解决入场偏差，然后再处理出场偏差。**

### 注意事项

- `lookahead-analysis` 只能验证/证伪其计算和检查过的交易。
如果策略有许多不同的信号/信号类型，您需要选择合适的参数以确保所有信号至少触发一次。未触发的信号将不会被验证。
这可能导致漏报，即策略被报告为无偏差。
- `lookahead-analysis` 可以使用相同的回测选项，这可能引入问题。
请不要使用启用仓位叠加等选项，因为这会扭曲检查的信号数量。
如果您决定使用，请确保不会用尽 `max_open_trades`  slots，且回测钱包配置中有足够的资金。
- 在结果表中，`biased_indicators` 列会错误地将 `set_freqai_targets()` 中定义的FreqAI目标指标标记为有偏差。
**这些指标没有偏差，可以安全忽略。**